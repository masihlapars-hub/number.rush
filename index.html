<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Number Rush — Sky Chaos</title>
<meta http-equiv="Cache-Control" content="no-store, max-age=0"/>
<style>
  :root{ --ink:#0f172a; --muted:#334155; --line:rgba(255,255,255,.35); --p1:#7c3aed; --p2:#a78bfa; --ok:#22c55e; --err:#ef4444; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
    background: linear-gradient(180deg,#bde0ff 0%,#a8d0ff 60%,#9bc8ff 100%);
    min-height:100svh;
    padding:max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right))
            max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
    overflow:auto;
  }

  /* BACKGROUND (belakang) */
  .bg-back{position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden}
  .sun{position:absolute; right:4vw; top:4vh; width:110px; height:110px; border-radius:50%;
       background:#ffd166; box-shadow:0 0 70px #ffd166bb, inset -14px -16px 0 #ffc43d; animation:pulse 4s ease-in-out infinite}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
  .bg-cloud{position:absolute; background:#fff; border-radius:60px; filter:drop-shadow(0 12px 26px rgba(0,0,0,.16))}
  .bg-cloud:before,.bg-cloud:after{content:""; position:absolute; background:#fff; border-radius:80px}
  .bg-cloud:before{width:70%; height:70%; left:-25%; top:10%}
  .bg-cloud:after{width:55%; height:55%; right:-20%; top:20%}
  @keyframes driftRight{from{transform:translateX(-150%)} to{transform:translateX(150%)}}
  .bg-cloud{animation:driftRight var(--t,85s) linear infinite; opacity:.9}

  /* WRAP & CARD */
  .wrap{position:relative; z-index:1; display:grid; place-items:center; min-height:calc(100svh - 24px)}
  .card{width:min(1120px,100%); background:rgba(255,255,255,.22); backdrop-filter: blur(12px) saturate(170%);
        border:1px solid var(--line); border-radius:18px; box-shadow:0 18px 46px rgba(15,23,42,.22); overflow:hidden}
  header{display:flex; gap:12px; align-items:center; padding:14px 16px; border-bottom:1px solid var(--line);
         background:linear-gradient(180deg, rgba(255,255,255,.34), rgba(255,255,255,.18))}
  .logo{width:30px; height:30px; display:grid; place-items:center; border-radius:10px; color:#fff; font-weight:800;
        background:conic-gradient(from 120deg, var(--p1), var(--p2))}
  header h1{font-size:18px; margin:0}
  .sub{font-size:12px; color:#1f2937}
  .content{display:grid; gap:14px; padding:14px}
  @media (min-width:980px){ .content{ grid-template-columns: 1.15fr .85fr; } }
  .panel{background:rgba(255,255,255,.18); border:1px solid var(--line); border-radius:16px; padding:14px; backdrop-filter: blur(10px)}
  .hud{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px}
  .stats{display:flex; gap:10px; flex-wrap:wrap}
  .chip{background:rgba(255,255,255,.55); border:1px solid var(--line); padding:8px 10px; border-radius:999px; font-size:13px; display:flex; gap:8px; align-items:center}
  .chip b{font-variant-numeric:tabular-nums}
  .chip.warn{box-shadow:0 0 0 3px #fecacaaa}
  select{border:1px solid var(--line); background:rgba(255,255,255,.95); padding:8px 10px; border-radius:10px; font-weight:700}
  .btn{appearance:none; border:0; background:linear-gradient(180deg, var(--p1), var(--p2)); color:#fff; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer; box-shadow:0 12px 28px rgba(124,58,237,.45)}
  .btn:active{transform:translateY(1px) scale(.99)}
  .toggle{appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.5); padding:8px 10px; border-radius:10px; font-weight:700; cursor:pointer}

  /* BOARD */
  .board-wrap{position:relative; display:grid; place-items:center}
  .board{
    width:100%; max-width:100%; block-size:min(72svh, 76vw); aspect-ratio:1/1;
    background: transparent; border-radius:14px; display:grid; gap:8px; padding:10px; overflow:hidden;
    border:1px solid rgba(255,255,255,.45);
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.18), 0 18px 36px rgba(0,0,0,.12);
    animation: boardGlow 3.5s ease-in-out infinite;
  }
  @keyframes boardGlow{0%,100%{box-shadow: inset 0 0 0 2px rgba(255,255,255,.18), 0 18px 36px rgba(0,0,0,.12)}50%{box-shadow: inset 0 0 0 2px rgba(255,255,255,.5), 0 26px 60px rgba(0,0,0,.2)}}
  .cell{
    display:grid; place-items:center; background:#fff; border:1px solid #e5e7eb; border-radius:12px; font-weight:900;
    /* FIX FONT SUPAYA NGGAK NGILANG DI HP */
    font-size: clamp(16px, 3vmin, 28px);
    color:#0f172a;
    user-select:none; cursor:pointer; transition: transform .08s ease, box-shadow .12s ease, background .12s ease;
    box-shadow:0 8px 16px rgba(15,23,42,.12)
  }
  .cell:hover{ box-shadow:0 14px 24px rgba(15,23,42,.18) }
  .cell.correct{ background:#ecfdf5; border-color:#bbf7d0 }
  .cell.wrong{ background:#fef2f2; border-color:#fecaca }
  .shake{ animation:shake .28s linear }
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}

  /* EFEK DEPAN (burung, layangan, bintang jatuh) */
  .fx-front{ position:absolute; inset:0; z-index:5; pointer-events:none; overflow:hidden; }
  .bird{
    position:absolute; width:34px; height:24px; animation:birdFly var(--bd,9s) linear forwards; opacity:.95;
    background: radial-gradient(circle at 50% 40%, #222 45%, transparent 46%) no-repeat center/100% 100%;
  }
  .bird:before,.bird:after{
    content:""; position:absolute; width:18px; height:12px; background:#222; border-radius:12px 12px 0 12px;
    top:6px; left:2px; transform-origin:left bottom; animation:wing .35s ease-in-out infinite;
  }
  .bird:after{ left:auto; right:2px; border-radius:12px 12px 12px 0; transform-origin:right bottom; }
  @keyframes wing{0%,100%{transform:rotate(8deg)}50%{transform:rotate(-24deg)}}
  @keyframes birdFly{from{transform:translateX(-15vw)} to{transform:translateX(115vw)}}

  .kite{
    position:absolute; width:18px; height:18px; border:2px solid #ef4444; transform:rotate(45deg);
    background:linear-gradient(45deg,#fca5a5,#fde68a); box-shadow:0 8px 14px rgba(0,0,0,.16);
    animation:kiteMove var(--kd,12s) ease-in-out forwards;
  }
  .kite:after{content:""; position:absolute; left:50%; top:100%; width:2px; height:60px; background:#475569; transform:translateX(-50%);}
  @keyframes kiteMove{
    0%{transform:translate(-10vw,10vh) rotate(45deg)}
    25%{transform:translate(20vw,0vh) rotate(50deg)}
    50%{transform:translate(50vw,12vh) rotate(40deg)}
    75%{transform:translate(80vw,-6vh) rotate(55deg)}
    100%{transform:translate(110vw,8vh) rotate(45deg)}
  }

  .shoot{
    position:absolute; width:120px; height:3px; background:linear-gradient(90deg,#ffffffee,transparent);
    filter:blur(.4px); opacity:.95; transform:rotate(-20deg);
    animation:shoot 1.1s linear forwards;
  }
  @keyframes shoot{from{transform:translate(100vw,-10vh) rotate(-20deg)} to{transform:translate(-20vw,60vh) rotate(-20deg)}}

  /* Overlay CHAOS */
  .flash{position:absolute; inset:-10%; background:#fff; opacity:0; animation:flash .28s ease forwards; mix-blend-mode:overlay}
  @keyframes flash{0%{opacity:0} 30%{opacity:.9} 100%{opacity:0}}
  .mist{position:absolute; inset:-10%; background:radial-gradient(ellipse at var(--x,50%) var(--y,50%), rgba(255,255,255,.5), transparent 60%); filter:blur(6px); animation:mist 1.2s ease forwards}
  @keyframes mist{from{opacity:.9} to{opacity:0}}

  /* Sidebar */
  .title{font-weight:800; margin:0 0 6px}
  .list{display:grid; gap:8px}
  .row{display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border:1px dashed var(--line); border-radius:10px; background:rgba(255,255,255,.25)}
  .tag{font-size:12px; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#4338ca; border:1px solid #e0e7ff}

  .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%) translateY(60px); opacity:0; background:#111827; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.2); z-index:20; transition: transform .25s ease, opacity .25s ease; font-size:14px}
  .toast.show{transform:translateX(-50%) translateY(0); opacity:1}
  .confetti{position:fixed; top:-10px; width:9px; height:14px; border-radius:2px; opacity:.95; pointer-events:none; z-index:15; animation:fall var(--t,2.6s) linear forwards}
  @keyframes fall{to{transform:translate3d(var(--x,0), 110svh, 0) rotate(720deg)}}
</style>
</head>
<body>
  <!-- BACKGROUND -->
  <div class="bg-back" aria-hidden="true" id="bg"><div class="sun"></div></div>

  <div class="wrap">
    <div class="card">
      <header>
        <div class="logo">NR</div>
        <div>
          <h1>Number Rush — <b>Sky Chaos</b></h1>
          <div class="sub">FX depan nonjok + musik. <b>CHAOS</b>, level 1–10, & difficulty lengkap.</div>
        </div>
      </header>

      <div class="content">
        <div class="panel">
          <div class="hud">
            <div class="stats">
              <div class="chip">Level:
                <select id="level">
                  <option value="1">1 • 1–20 • 25s</option>
                  <option value="2">2 • 1–30 • 35s</option>
                  <option value="3">3 • 1–40 • 45s</option>
                  <option value="4">4 • 1–50 • 55s</option>
                  <option value="5">5 • 1–60 • 65s</option>
                  <option value="6">6 • 1–70 • 70s</option>
                  <option value="7">7 • 1–80 • 75s</option>
                  <option value="8">8 • 1–90 • 80s</option>
                  <option value="9">9 • 1–100 • 90s</option>
                  <option value="10">10 • 1–100 (rapat) • 75s</option>
                </select>
              </div>
              <div class="chip">Difficulty:
                <select id="difficulty">
                  <option value="normal">Normal</option>
                  <option value="hard">Hard</option>
                  <option value="flash">Flash</option>
                  <option value="swap">Swap</option>
                  <option value="sudden">Sudden Death</option>
                </select>
              </div>
              <div class="chip">Target: <b id="target">1</b></div>
              <div class="chip" id="chipTime">Sisa: <b id="time">25.000</b>s</div>
              <div class="chip">Rekor: <b id="best">—</b></div>
              <div class="chip">Combo: <b id="combo">0</b>/<b id="comboNeed">5</b></div>
            </div>
            <div style="display:flex; gap:8px; align-items:center">
              <button class="toggle" id="toggleMusic">Music: ON</button>
              <button class="toggle" id="toggleChaos">CHAOS: OFF</button>
              <button class="btn" id="btnStart">Mulai / Ulang</button>
            </div>
          </div>

          <div class="board-wrap">
            <div id="board" class="board"></div>
            <!-- LAYER EFEK DEPAN -->
            <div class="fx-front" id="fxFront" aria-hidden="true"></div>
          </div>
        </div>

        <aside class="panel sidebar">
          <h3 class="title">Aturan cepat</h3>
          <div class="list">
            <div class="row"><span>Countdown</span><span class="tag">habis → game over</span></div>
            <div class="row"><span>Combo</span><span class="tag">capai N cepat → +3s (N sesuai difficulty)</span></div>
            <div class="row"><span>Hard</span><span class="tag">penalti -3s, N=6</span></div>
            <div class="row"><span>Flash</span><span class="tag">angka blackout periodik</span></div>
            <div class="row"><span>Swap</span><span class="tag">dua angka tukar posisi</span></div>
            <div class="row"><span>Sudden Death</span><span class="tag">salah sekali → tamat</span></div>
            <div class="row"><span>CHAOS</span><span class="tag">FX 3× + flash/kabut/shake</span></div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Rekor baru! 🎉</div>

  <!-- MUSIK LATAR -->
  <audio id="bgm" loop src="happy_bgm.mp3" preload="auto"></audio>

<script>
(()=> {
  const $=(s,o=document)=>o.querySelector(s);
  const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const shuffle=(a)=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};

  const levelSel=$('#level'), diffSel=$('#difficulty'),
        targetEl=$('#target'), timeEl=$('#time'), bestEl=$('#best'),
        chipTime=$('#chipTime'), comboEl=$('#combo'), comboNeedEl=$('#comboNeed'),
        board=$('#board'), btn=$('#btnStart'), toast=$('#toast'),
        chaosBtn=$('#toggleChaos'), musicBtn=$('#toggleMusic'), bgm=$('#bgm');
  const BG=$('#bg'), FX=$('#fxFront');

  const levels={
    1:{max:20, cols:5, rows:4, time:25},
    2:{max:30, cols:6, rows:5, time:35},
    3:{max:40, cols:7, rows:6, time:45},
    4:{max:50, cols:8, rows:7, time:55},
    5:{max:60, cols:8, rows:8, time:65},
    6:{max:70, cols:9, rows:8, time:70},
    7:{max:80, cols:10, rows:8, time:75},
    8:{max:90, cols:10, rows:9, time:80},
    9:{max:100, cols:10, rows:10, time:90},
    10:{max:100, cols:10, rows:10, time:75}
  };

  // ===== STATE =====
  let seq=1, maxN=20, started=false, deadline=0, ticker=null, remaining=0;
  let lastHit=0, combo=0, chaos=false;
  let penaltyWrong=2, comboNeed=5, sudden=false;
  let ivBird, ivKite, ivShoot, ivFlash, ivMist, ivShake, ivSwap, ivBlackout;
  const audioCtx='AudioContext' in window ? new AudioContext() : null;

  /* ===== BACK SKY ===== */
  function buildBackSky(){
    BG.innerHTML='<div class="sun"></div>';
    for(let i=0;i<8;i++){
      const c=document.createElement('div');
      c.className='bg-cloud';
      const sz=rand(100,200); c.style.width=sz+'px'; c.style.height=sz*.45+'px';
      c.style.top=rand(8,70)+'vh'; c.style.left=rand(-140,-40)+'%';
      c.style.setProperty('--t', rand(70,100)+'s');
      BG.appendChild(c);
    }
  }

  /* ===== FOREGROUND FX ===== */
  function spawnBird(leftToRight=true){
    const b=document.createElement('div'); b.className='bird';
    b.style.top=rand(8,85)+'%'; b.style.setProperty('--bd', (chaos?5.5:8.5)+'s');
    if(!leftToRight){ b.style.transform='scaleX(-1)'; b.style.animation='birdFly var(--bd) linear reverse forwards'; b.style.left='115vw'; }
    FX.appendChild(b); b.addEventListener('animationend',()=>b.remove());
  }
  function spawnKite(){
    const k=document.createElement('div'); k.className='kite';
    k.style.setProperty('--kd', (chaos?8:12)+'s'); FX.appendChild(k);
    k.addEventListener('animationend',()=>k.remove());
  }
  function spawnShoot(){ const s=document.createElement('div'); s.className='shoot'; FX.appendChild(s); s.addEventListener('animationend',()=>s.remove()); }
  function flash(){ const f=document.createElement('div'); f.className='flash'; FX.appendChild(f); f.addEventListener('animationend',()=>f.remove()); }
  function mist(){ const m=document.createElement('div'); m.className='mist'; m.style.setProperty('--x', rand(20,80)+'%'); m.style.setProperty('--y', rand(20,80)+'%'); FX.appendChild(m); m.addEventListener('animationend',()=>m.remove()); }
  function shake(){ board.classList.remove('shake'); void board.offsetWidth; board.classList.add('shake'); }

  function startFX(){
    stopFX();
    ivBird =setInterval(()=>spawnBird(Math.random()>.5), chaos? 900:2200);
    ivKite =setInterval(spawnKite,                         chaos? 1800:4200);
    ivShoot=setInterval(spawnShoot,                        chaos? 2000:5000);
    // Event chaos tambahan
    ivFlash= setInterval(()=> chaos && flash(), chaos? 3000:9999999);
    ivMist = setInterval(()=> chaos && mist(),  chaos? 2400:9999999);
    ivShake= setInterval(()=> chaos && shake(), chaos? 2600:9999999);
  }
  function stopFX(){ [ivBird,ivKite,ivShoot,ivFlash,ivMist,ivShake].forEach(x=>x&&clearInterval(x)); }

  /* ===== GRID ===== */
  function buildGrid(cfg){
    const {max, cols, rows, time}=cfg;
    maxN=max; seq=1; targetEl.textContent='1'; combo=0; comboEl.textContent='0';
    board.classList.remove('shake'); board.innerHTML='';
    board.style.gridTemplateColumns=`repeat(${cols}, 1fr)`; board.style.gridTemplateRows=`repeat(${rows}, 1fr)`;
    const arr=shuffle(Array.from({length:max},(_,i)=>i+1));
    arr.forEach(n=>{
      const c=document.createElement('button');
      c.type='button'; c.className='cell'; c.textContent=n; c.setAttribute('aria-label','angka '+n);
      c.addEventListener('click',()=>onClick(c,n));
      board.appendChild(c);
    });
    remaining=time; timeEl.textContent=remaining.toFixed(3);
    stopTicker(true);

    // difficulty timers
    stopDifficultyTimers();
    const d=diffSel.value;
    if(d==='flash'){ // blackout semua angka periodik
      ivBlackout=setInterval(()=>{
        board.querySelectorAll('.cell').forEach(c=>c.style.opacity='0');
        setTimeout(()=>board.querySelectorAll('.cell').forEach(c=>c.style.opacity='1'), 700);
      }, 3000);
    }
    if(d==='swap' || chaos){ // swap dua angka periodik (chaos juga swap)
      ivSwap=setInterval(()=>{
        const cells=[...board.querySelectorAll('.cell')].filter(c=>!c.disabled);
        if(cells.length<2) return;
        const a=cells[Math.floor(Math.random()*cells.length)];
        const b=cells[Math.floor(Math.random()*cells.length)];
        if(a===b) return;
        const ta=a.textContent; a.textContent=b.textContent; b.textContent=ta;
      }, d==='swap' ? 2600 : 3800);
    }
  }
  function stopDifficultyTimers(){ [ivSwap,ivBlackout].forEach(x=>x&&clearInterval(x)); }

  /* ===== TIMER ===== */
  function startTicker(){
    started=true; deadline=performance.now()+remaining*1000;
    ticker=setInterval(()=>{
      remaining=(deadline-performance.now())/1000; if(remaining<0) remaining=0;
      timeEl.textContent=remaining.toFixed(3);
      if(remaining===0){ stopTicker(); gameOver(); }
    }, 25);
  }
  function stopTicker(reset=false){ if(ticker){clearInterval(ticker); ticker=null} if(reset) started=false }

  /* ===== AUDIO SFX ===== */
  function pop(ok=true){
    if(!audioCtx) return;
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='triangle'; o.frequency.value=ok?760:210; g.gain.value=.0001;
    o.connect(g); g.connect(audioCtx.destination); o.start();
    const t=audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(.26, t+.01); g.gain.exponentialRampToValueAtTime(.0001, t+.1); o.stop(t+.12);
  }
  function confetti(n=160){
    for(let i=0;i<n;i++){
      const e=document.createElement('div'); e.className='confetti';
      e.style.left=(50+(Math.random()*60-30))+'vw';
      e.style.background=`hsl(${Math.random()*360}, 90%, 60%)`;
      e.style.setProperty('--x', (Math.random()*100 - 50)+'vw');
      e.style.setProperty('--t', (2+Math.random()*1.8)+'s');
      document.body.appendChild(e); e.addEventListener('animationend', ()=>e.remove());
    }
  }
  function toastMsg(t){ toast.textContent=t; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1800) }

  /* ===== REKOR ===== */
  const key=(lvl,df)=>`nr_best_${lvl}_${df}`;
  const loadBest=(lvl,df)=>{const v=localStorage.getItem(key(lvl,df)); return v?parseFloat(v):null};
  const saveBest=(lvl,df,val)=>{const b=loadBest(lvl,df); if(b==null||val<b){localStorage.setItem(key(lvl,df), String(val.toFixed(3))); return true} return false};
  const renderBest=(lvl,df)=>{const b=loadBest(lvl,df); bestEl.textContent=b?`${b.toFixed(3)}s`:'—'};

  /* ===== DIFFICULTY ===== */
  function applyDifficulty(){
    const d=diffSel.value;
    penaltyWrong=2; comboNeed=5; sudden=false;
    if(d==='hard'){ penaltyWrong=3; comboNeed=6; }
    if(d==='sudden'){ sudden=true; penaltyWrong=0; }
    comboNeedEl.textContent=comboNeed;
  }

  /* ===== GAMEPLAY ===== */
  function penalize(sec){ if(sec<=0) return; remaining=Math.max(0, remaining-sec); chipTime.classList.add('warn'); setTimeout(()=>chipTime.classList.remove('warn'), 260); }
  function addTime(sec){ remaining+=sec; deadline+=sec*1000; toastMsg(`Bonus +${sec}s ⏱️`); }

  function onClick(cell,n){
    if(!started){ audioCtx?.resume?.(); startTicker(); lastHit=performance.now(); }
    if(n===seq){
      cell.classList.add('correct'); cell.disabled=true; seq++; targetEl.textContent= seq<=maxN? seq : '✔'; pop(true);
      const now=performance.now();
      if(now-lastHit<=900){ combo++; } else { combo=1; }
      lastHit=now; comboEl.textContent=String(Math.min(combo,comboNeed));
      if(combo>=comboNeed){ addTime(3); combo=0; comboEl.textContent='0'; }
      if(seq>maxN){
        stopTicker();
        const used=levels[parseInt(levelSel.value,10)].time - remaining;
        const isBest=saveBest(parseInt(levelSel.value,10), diffSel.value, used);
        renderBest(parseInt(levelSel.value,10), diffSel.value);
        confetti(200); toastMsg(isBest?'Rekor baru! 🎉':'Selesai! ✅');
      }
    } else {
      pop(false); board.classList.remove('shake'); void board.offsetWidth; board.classList.add('shake');
      cell.classList.add('wrong'); setTimeout(()=>cell.classList.remove('wrong'),220);
      if(sudden){ gameOver(); return; }
      penalize(penaltyWrong); if(remaining===0){ stopTicker(); gameOver(); }
    }
  }
  function gameOver(){ toastMsg('Game Over! ⏰'); board.querySelectorAll('.cell').forEach(c=>c.disabled=true); }

  /* ===== START / RESET ===== */
  function start(){
    const lvl=parseInt(levelSel.value,10), cfg=levels[lvl];
    applyDifficulty();
    buildBackSky(); buildGrid(cfg); renderBest(lvl, diffSel.value); startFX();
    if(lvl===10){ board.style.gap='6px'; } else { board.style.gap='8px'; }
  }

  /* ===== MUSIC ===== */
  bgm.volume=0.3;
  function tryPlayMusic(){ bgm.play().then(()=>{ musicBtn.textContent='Music: ON'; musicBtn.dataset.off='0'; }).catch(()=>{ document.body.addEventListener('click', ()=>bgm.play(), {once:true}); }); }
  window.addEventListener('load', tryPlayMusic);
  musicBtn.addEventListener('click', ()=>{ if(bgm.paused){ bgm.play().catch(()=>{}); musicBtn.textContent='Music: ON'; musicBtn.dataset.off='0'; } else { bgm.pause(); bgm.currentTime=0; musicBtn.textContent='Music: OFF'; musicBtn.dataset.off='1'; } });

  /* ===== BIND UI ===== */
  btn.addEventListener('click', start);
  levelSel.addEventListener('change', start);
  diffSel.addEventListener('change', start);
  chaosBtn.addEventListener('click', ()=>{ chaos=!chaos; chaosBtn.textContent=`CHAOS: ${chaos?'ON':'OFF'}`; startFX(); });

  // init
  buildBackSky(); applyDifficulty(); buildGrid(levels[1]); renderBest(1,'normal'); startFX();
})();
</script>
</body>
</html>
